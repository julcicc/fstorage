<!DOCTYPE HTML>
<html>
<head>
    <!-- bootstrap min css + theme css -->
    <link rel="stylesheet" href="bootstrap.min.css">
<style>
html {
margin: 10px 10px 10px 10px;
}
#panel {
    display:none;
}
#noServerAlert {
    display:none;
}
#errorAlert{
    display:none;
}
</style>

</head>
<body>
<div class="alert alert-danger" role="alert" id="errorAlert">
Error contacting server
<button type="button" class="close" data-dismiss="alert" aria-label="Close">
  <span aria-hidden="true">&times;</span>
</button>
</div>
<div class="alert alert-danger" role="alert" id="noServerAlert">
Server not available
<button type="button" class="close" data-dismiss="alert" aria-label="Close">
  <span aria-hidden="true">&times;</span>
</button>
</div>
<div class="row" id="form">
	<div class="col-md-4">

<form onSubmit="checkAndStart()">
  <div class="form-group">
    <label for="inputServerUrl">Server URL</label>
    <input type="text" class="form-control" id="inputServerUrl" placeholder="http://myserver.com/fstorage_server/api.php" required>
  </div>
  <div class="form-group">
    <label for="inputServerUser">User</label>
    <input type="text" class="form-control" id="inputServerUser" required>
  </div>
  <div class="form-group">
    <label for="inputServerPass">Pass</label>
    <input type="password" class="form-control" id="inputServerPass" required>
  </div>
  <button type="submit" class="btn btn-default">Start!</button>
</form>
	</div>
	<div class="col-md-8">&nbsp;</div>
</div>
<div class="row" id="panel">
    <div class="col-md-2">
    <table class="table condensed">
        <tbody id="bucketRows">
            <thead>
                <tr>
                    <th>Bucket</th>
                </tr>
            </thead>
            <tbody id="bucketList">
            </tbody>
    </table>
    </div>
    <div class="col-md-10">
    <table class="table condensed table-striped">
        <tbody id="objectRows">
            <thead>
                <tr>
                    <th>Key</th>
                    <th>Size</th>
                    <th>Type</th>
                    <th>Created</th>
                    <th>Modified</th>
                    <th>Content MD5</th>
                </tr>
            </thead>
        </tbody>
    </table>
    <tfoot id="objectFooter">
        <tr>
            <td colspan="6" align="center">No objects</td>
        </tr>
    </tfoot>
    </div>
</div>
</body>
<script id="bucketRowsTmpl" type="x-tmpl-mustache">
{{#result}}
<tr><td><small><a href="javascript:selectBucket('{{bucket_name}}','{{bucket_description}}')">{{bucket_name}}</a></small></td></tr>
{{/result}}
</script>
<script id="objectRowsTmpl" type="x-tmpl-mustache">
{{#result}}
<tr>
    <td><a target="_blank" href="{{url}}">{{key}}</a></td>
    <td><small>{{sizeFormatted}}</small></td>
    <td>{{contentType}}</td>
    <td><small>{{dateCreated}}</small></td>
    <td><small>{{dateModified}}</small></td>
    <td><small><small>{{contentMD5}}</small></small></td>
</tr>
{{/result}}
</script>
<!-- jquery + bootstrap js + mustache js -->
<script src="libs.min.js"></script>
<script>
SERVER_URL = "";
SERVER_USER = "";
SERVER_PASS = "";

CURRENT_OBJECTS = null;
function mergeData(targetSelector, templateName, data, finishCB) {
            if ((typeof targetSelector !== "string") ||
               (typeof templateName !== "string") ||
                (data === undefined || data === null)) {
                console.error("missing argument in mergeData");
                return;
            }

            t = window.$(targetSelector);

			var template = $('#' + templateName).html();
			Mustache.parse(template);
			t.html( Mustache.render(template, data) );
            if(finishCB) finishCB()
}

function fsAPI(name,param) {
	var myParams = { "user" : SERVER_USER, "pass" : SERVER_PASS, "method" : name }
	if (param) for ( key in param ) {
		myParams[key] = param[key];
	}

	return $.ajax({url:SERVER_URL, data:myParams, error: function(xhr,ajaxOptions,thrownError){
		$('#errorAlert').show();
	}});
}

function checkAndStart() {
	event.preventDefault();
	SERVER_URL = $('#inputServerUrl').val();
	SERVER_USER = $('#inputServerUser').val();
	SERVER_PASS = $('#inputServerPass').val();

	fsAPI("noop").done( function(data){ 
		if (data && data.status == "ok") {
			$('#form').hide();
			$('#panel').show();
			start();	
		}
		else {
			$('#noServerAlert').show();
		}
	} );
}

function start() {
	fsAPI("listBuckets").done( function(data){
		mergeData("#bucketRows","bucketRowsTmpl", data);
	});
}

function selectBucket(bucketName) {
    $('#objectFooter').hide();
    fsAPI("listObjects", {"bucket":bucketName,"search":"*"}).done( function(data){
        CURRENT_OBJECTS = data;
        if (data.result && data.result.length) {
            for (k in data.result) {
                data.result[k].sizeFormatted = bytesToSize(data.result[k].contentSize);
                data.result[k].url = data.result[k].url + "&user=" + SERVER_USER + "&pass=" + SERVER_PASS;
            }
            mergeData("#objectRows","objectRowsTmpl",data);
        }
        else {
         $('#objectFooter').show();
        }

        
	});
}

function bytesToSize(bytes) {
    var sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
    if (bytes == 0) return 'n/a';
    var i = parseInt(Math.floor(Math.log(bytes) / Math.log(1024)));
    if (i == 0) return bytes + ' ' + sizes[i];
    return (bytes / Math.pow(1024, i)).toFixed(1) + ' ' + sizes[i];
}

</script>
</html>
